<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å•è¯ç®¡ç†ä¸é»˜å†™&å¬å†™ç³»ç»Ÿ</title>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    header { background: #4CAF50; color: white; text-align: center; padding: 10px; }
    nav { display: flex; justify-content: center; background: #333; }
    nav button { flex: 1; color: white; background: none; border: none; padding: 10px; cursor: pointer; }
    nav button:hover { background: #575757; }
    .container { padding: 20px; }
    .hidden { display: none; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f2f2f2; }
    .input-word { width: 70%; padding: 4px; }
    .btn { margin: 10px 0; padding: 6px 12px; cursor: pointer; }
    textarea { width: 100%; height: 60px; }
    .play-btn { margin-right: 8px; cursor: pointer; }
    .delete-btn { color: red; cursor: pointer; }
  </style>
</head>
<body>
  <header><h1>å•è¯ç®¡ç†ä¸é»˜å†™â€‹&â€‹å¬å†™ç³»ç»Ÿ</h1></header>
  <nav>
    <button data-section="words">å•è¯ç®¡ç†</button>
    <button data-section="dictate">é»˜å†™ç»ƒä¹ </button>
    <button data-section="listen">å¬å†™ç»ƒä¹ </button>
    <button data-section="review">å¤ä¹ ç³»ç»Ÿ</button>
  </nav>
  <div class="container">
    <!-- å•è¯ç®¡ç† -->
    <section id="words">
      <h2>å•è¯ç®¡ç†</h2>
      <textarea id="bulkInput" placeholder="ç”¨ç©ºæ ¼åˆ†éš”è‹±æ–‡å•è¯"></textarea>
      <button id="bulkAddBtn" class="btn">æ‰¹é‡æ·»åŠ å•è¯</button>
      <table>
        <thead><tr><th>å•è¯</th><th>é‡Šä¹‰</th><th>å¤‡æ³¨</th><th>é»˜å†™</th><th>å¬å†™</th><th>åˆ é™¤</th></tr></thead>
        <tbody id="manageBody"></tbody>
      </table>
    </section>
    <!-- é»˜å†™ -->
    <section id="dictate" class="hidden">
      <h2>é»˜å†™ç»ƒä¹ </h2>
      <button id="startDictBtn" class="btn">å¼€å§‹é»˜å†™</button>
      <div id="dictForm"></div>
      <button id="gradeDictBtn" class="btn">æ‰¹æ”¹é»˜å†™</button>
      <div id="dictResult"></div>
    </section>
    <!-- å¬å†™ -->
    <section id="listen" class="hidden">
      <h2>å¬å†™ç»ƒä¹ </h2>
      <button id="startListenBtn" class="btn">å¼€å§‹å¬å†™</button>
      <div id="listenForm"></div>
      <button id="gradeListenBtn" class="btn">æ‰¹æ”¹å¬å†™</button>
      <div id="listenResult"></div>
    </section>
    <!-- å¤ä¹  -->
    <section id="review" class="hidden">
      <h2>å¤ä¹ ç³»ç»Ÿ</h2>
      <button id="loadReviewBtn" class="btn">åŠ è½½é”™è¯</button>
      <div id="reviewForm"></div>
      <button id="gradeReviewBtn" class="btn">æ‰¹æ”¹å¤ä¹ </button>
      <div id="reviewResult"></div>
    </section>
  </div>
  <script>
    // åˆå§‹åŒ–æ•°æ®
    const KEY = 'vocabData';
    let data = JSON.parse(localStorage.getItem(KEY) || 'null');
    if(!data) { data = { '2025-08-01': [] }; localStorage.setItem(KEY, JSON.stringify(data)); }
    // ä¿å­˜æ•°æ®
    function save() { localStorage.setItem(KEY, JSON.stringify(data)); }
    // DOM å¼•ç”¨
    const sections = document.querySelectorAll('nav button');
    const manageBody = document.getElementById('manageBody');
    const bulkAddBtn = document.getElementById('bulkAddBtn');
    const bulkInput = document.getElementById('bulkInput');
    const startDictBtn = document.getElementById('startDictBtn');
    const dictForm = document.getElementById('dictForm');
    const gradeDictBtn = document.getElementById('gradeDictBtn');
    const dictResult = document.getElementById('dictResult');
    const startListenBtn = document.getElementById('startListenBtn');
    const listenForm = document.getElementById('listenForm');
    const gradeListenBtn = document.getElementById('gradeListenBtn');
    const listenResult = document.getElementById('listenResult');
    const loadReviewBtn = document.getElementById('loadReviewBtn');
    const reviewForm = document.getElementById('reviewForm');
    const gradeReviewBtn = document.getElementById('gradeReviewBtn');
    const reviewResult = document.getElementById('reviewResult');
    // åˆ‡æ¢
    sections.forEach(btn => btn.onclick = ()=>{
      document.querySelectorAll('section').forEach(s=>s.classList.add('hidden'));
      document.getElementById(btn.dataset.section).classList.remove('hidden');
    });
    // æ¸²æŸ“ç®¡ç†
    function renderManage() {
      manageBody.innerHTML = '';
      data['2025-08-01'].forEach((it,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${it.word}</td>
          <td>${it.meaning}</td>
          <td contenteditable onblur="it.note=this.innerText; data['2025-08-01'][${i}].note=it.note; save();">${it.note||''}</td>
          <td><input type='checkbox' ${it.passedDict?'checked':''} onchange="it.passedDict=this.checked; data['2025-08-01'][${i}].passedDict=it.passedDict; save();"></td>
          <td><input type='checkbox' ${it.passedListen?'checked':''} onchange="it.passedListen=this.checked; data['2025-08-01'][${i}].passedListen=it.passedListen; save();"></td>
          <td><span class='delete-btn' onclick="data['2025-08-01'].splice(${i},1); save(); renderManage();">ğŸ—‘ï¸</span></td>
        `;
        manageBody.appendChild(tr);
      });
    }
    // æ‰¹é‡æ·»åŠ 
    bulkAddBtn.onclick = async ()=>{
      bulkAddBtn.disabled = true; bulkAddBtn.innerText = 'æ·»åŠ ä¸­...';
      const words = bulkInput.value.trim().split(/\s+/);
      for(const w of words) {
        if(data['2025-08-01'].some(it=>it.word===w)) continue;
        let meaning = '';
        try { const r = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${w}`);
          const j = await r.json(); meaning = j[0]?.meanings[0]?.definitions[0].definition || '';
        } catch {};
        if(!meaning) { meaning = prompt(`è¯·è¾“å…¥ "${w}" çš„ä¸­æ–‡é‡Šä¹‰:`,''); if(!meaning) continue; }
        data['2025-08-01'].push({word:w,meaning,passedDict:false,passedListen:false});
      }
      save(); renderManage();
      bulkAddBtn.disabled = false; bulkAddBtn.innerText = 'æ‰¹é‡æ·»åŠ å•è¯';
    };
    // é»˜å†™é€»è¾‘
    startDictBtn.onclick = ()=>{
      dictForm.innerHTML = '';
      data['2025-08-01'].forEach((it,i)=>{
        dictForm.innerHTML += `<div><label>${it.meaning}</label><input id='d${i}' class='input-word'></div>`;
      });
    };
    gradeDictBtn.onclick = ()=>{
      let correct = 0, errs = [];
      data['2025-08-01'].forEach((it,i)=>{
        const a = document.getElementById('d'+i).value.trim().toLowerCase();
        if(a===it.word) { correct++; it.passedDict = true; } else { errs.push({it,attempt:a}); it.passedDict=false; }
      });
      save(); renderManage();
      dictResult.innerHTML = `<p>æ­£ç¡® ${correct}/${data['2025-08-01'].length}</p>` +
        (errs.length?'<ul style="color:red">'+errs.map(e=>`<li>${e.it.word} ä½ : ${e.attempt}</li>`).join('')+'</ul>':'' );
    };
    // å¬å†™é€»è¾‘
    startListenBtn.onclick = ()=>{
      listenForm.innerHTML = '';
      data['2025-08-01'].forEach((it,i)=>{
        listenForm.innerHTML += `<div><button class='play-btn' onclick="speechSynthesis.speak(new SpeechSynthesisUtterance('${it.word}'))">ğŸ”Š</button><input id='l${i}' class='input-word'></div>`;
      });
    };
    gradeListenBtn.onclick = ()=>{
      let correct = 0, errs = [];
      data['2025-08-01'].forEach((it,i)=>{
        const a = document.getElementById('l'+i).value.trim().toLowerCase();
        if(a===it.word) { correct++; it.passedListen=true; } else { errs.push({it,attempt:a}); it.passedListen=false; }
      });
      save(); renderManage();
      listenResult.innerHTML = `<p>æ­£ç¡® ${correct}/${data['2025-08-01'].length}</p>` +
        (errs.length?'<ul style="color:red">'+errs.map(e=>`<li>${e.it.word} ä½ : ${e.attempt}</li>`).join('')+'</ul>':'' );
    };
    // å¤ä¹ 
    loadReviewBtn.onclick = ()=>{
      reviewForm.innerHTML = '';
      const list = JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');
      list.slice(0,20).forEach((it,i)=>{
        reviewForm.innerHTML += `<div><button onclick="speechSynthesis.speak(new SpeechSynthesisUtterance('${it.word}'))">ğŸ”Š</button><label>${it.meaning}</label><input id='r${i}' class='input-word'></div>`;
      });
    };
    gradeReviewBtn.onclick = ()=>{
      let list = JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');
      const group = list.slice(0,20);
      const remain = list.slice(20);
      const errs = [];
      group.forEach((e,i)=>{ const a=document.getElementById('r'+i).value.trim().toLowerCase(); if(a!==e.word) errs.push(e); });
      localStorage.setItem(KEY_REVIEW, JSON.stringify(errs.concat(remain)));
      reviewResult.innerText = `å‰©ä½™ ${errs.concat(remain).length}`;
    };
    // å¯åŠ¨æ¸²æŸ“
    window.onload = ()=>{ renderManage(); };
  </script>
</body>
</html>
