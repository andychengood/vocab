<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>单词管理与默写&听写系统</title>
  <style>
    body{font-family:sans-serif;margin:0;padding:0;background:#f9f9f9}
    header{background:#4CAF50;color:white;padding:10px;text-align:center}
    nav{display:flex;justify-content:center;background:#333}
    nav button{flex:1;color:white;background:none;border:none;padding:10px;cursor:pointer}
    nav button:hover{background:#575757}
    .container{padding:20px}
    section{display:none}
    section.active{display:block}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f2f2f2}
    .input-word{width:70%;padding:4px}
    .btn{margin:10px 0;padding:6px 12px;cursor:pointer}
    textarea{width:100%;height:60px}
    .play-btn{margin-right:8px;cursor:pointer}
    .delete-btn{color:red;cursor:pointer}
    ul{padding-left:20px;color:red}
  </style>
</head>
<body>
  <header><h1>单词管理与默写&听写系统</h1></header>
  <nav>
    <button data-sec="words">单词管理</button>
    <button data-sec="dictate">默写练习</button>
    <button data-sec="listen">听写练习</button>
    <button data-sec="review">复习系统</button>
  </nav>
  <div class="container">
    <section id="words" class="active">
      <h2>单词管理</h2>
      <textarea id="bulkInput" placeholder="用空格分隔英文单词"></textarea>
      <button id="bulkAddBtn" class="btn">批量添加单词</button>
      <table><thead><tr><th>单词</th><th>释义</th><th>备注</th><th>默写通过</th><th>听写通过</th><th>删除</th></tr></thead><tbody id="manageBody"></tbody></table>
    </section>
    <section id="dictate">
      <h2>默写练习</h2>
      <button id="startDictBtn" class="btn">开始默写</button>
      <div id="dictForm"></div>
      <button id="gradeDictBtn" class="btn">批改默写</button>
      <div id="dictResult"></div>
    </section>
    <section id="listen">
      <h2>听写练习</h2>
      <button id="startListenBtn" class="btn">开始听写</button>
      <div id="listenForm"></div>
      <button id="gradeListenBtn" class="btn">批改听写</button>
      <div id="listenResult"></div>
    </section>
    <section id="review">
      <h2>复习系统</h2>
      <button id="loadReviewBtn" class="btn">加载错词</button>
      <div id="reviewForm"></div>
      <button id="gradeReviewBtn" class="btn">批改复习</button>
      <div id="reviewResult"></div>
    </section>
  </div>
<script>
// 数据持久化
const KEY='vocabData',KEY_DICT='dictRecords',KEY_LISTEN='listenRecords',KEY_REVIEW='reviewList';
let data=JSON.parse(localStorage.getItem(KEY)||'null');
if(!data){data={'2025-08-01':[]};localStorage.setItem(KEY,JSON.stringify(data));}
function save(){localStorage.setItem(KEY,JSON.stringify(data));}
function getList(){return data['2025-08-01'];}
// 切换
document.querySelectorAll('nav button').forEach(btn=>btn.onclick=()=>{
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(btn.dataset.sec).classList.add('active');
});
// 渲染管理
function renderManage(){
  const body=document.getElementById('manageBody');body.innerHTML='';
  getList().forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.word}</td><td>${it.meaning}</td>
      <td contenteditable onblur="it.note=this.innerText;save();">${it.note||''}</td>
      <td><input type=checkbox ${it.passedDict?'checked':''} onchange="it.passedDict=this.checked;save();"></td>
      <td><input type=checkbox ${it.passedListen?'checked':''} onchange="it.passedListen=this.checked;save();"></td>
      <td><span class=delete-btn onclick="getList().splice(${i},1);save();renderManage();">🗑️</span></td>`;
    body.appendChild(tr);
  });
}
// 自动抓取中译
async function bulkAdd(){
  const btn=document.getElementById('bulkAddBtn');btn.disabled=true;btn.innerText='添加中...';
  const words=document.getElementById('bulkInput').value.trim().split(/\s+/);
  for(const w of words){
    if(getList().some(it=>it.word===w))continue;
    let meaning='';
    try{const res=await fetch('https://api.dictionaryapi.dev/api/v2/entries/en/'+w);
      const j=await res.json();meaning=j[0]?.meanings[0]?.definitions[0]?.definition||'';}catch{}
    if(!meaning){const m=prompt(`未找到"${w}"释义，请输入:`,`中文`);if(!m)continue;meaning=m;}
    getList().push({word:w,meaning,passedDict:false,passedListen:false});
  }
  save();renderManage();btn.innerText='批量添加单词';btn.disabled=false;
}
document.getElementById('bulkAddBtn').onclick=bulkAdd;
// 默写
function startDict(){const form=document.getElementById('dictForm');form.innerHTML='';getList().forEach((it,i)=>
  form.innerHTML+=`<div><label>${it.meaning}</label><input id=d${i} class=input-word></div>`);
}
function gradeDict(){let ok=0,errs=[];getList().forEach((it,i)=>{const a=document.getElementById('d'+i).value.trim().toLowerCase();
  if(a===it.word){ok++;it.passedDict=true;}else{errs.push({word:it.word,attempt:a});it.passedDict=false;}});
  save();renderManage();
  let r=`<p>正确 ${ok}/${getList().length}</p>`;
  if(errs.length){r+='<ul>'+errs.map(e=>`<li>${e.word} 你: ${e.attempt}</li>`).join('')+'</ul>';addToReview(errs);}  
  document.getElementById('dictResult').innerHTML=r;
}
document.getElementById('startDictBtn').onclick=startDict;
document.getElementById('gradeDictBtn').onclick=gradeDict;
// 听写
function startListen(){const f=document.getElementById('listenForm');f.innerHTML='';getList().forEach((it,i)=>
  f.innerHTML+=`<div><button class=play-btn onclick="speak('${it.word}')">🔊</button><input id=l${i} class=input-word></div>`);
}
function gradeListen(){let ok=0,errs=[];getList().forEach((it,i)=>{const a=document.getElementById('l'+i).value.trim().toLowerCase();
  if(a===it.word){ok++;it.passedListen=true;}else{errs.push({word:it.word,attempt:a});it.passedListen=false;}});
  save();renderManage();
  let r=`<p>正确 ${ok}/${getList().length}</p>`;
  if(errs.length){r+='<ul>'+errs.map(e=>`<li>${e.word} 你: ${e.attempt}</li>`).join('')+'</ul>';addToReview(errs);}  
  document.getElementById('listenResult').innerHTML=r;
}
document.getElementById('startListenBtn').onclick=startListen;
document.getElementById('gradeListenBtn').onclick=gradeListen;
// 复习
function addToReview(arr){const lst=JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');localStorage.setItem(KEY_REVIEW,JSON.stringify(lst.concat(arr)));}
function loadReview(){const f=document.getElementById('reviewForm'),lst=JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');f.innerHTML='';lst.slice(0,20).forEach((it,i)=>
  f.innerHTML+=`<div><button class=play-btn onclick="speak('${it.word}')">🔊</button><label>${it.meaning}</label><input id=r${i} class=input-word></div>`);
}
function gradeReview(){let lst=JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]'),errs=[],grp=lst.slice(0,20),rem=lst.slice(20);
  grp.forEach((it,i)=>{const a=document.getElementById('r'+i).value.trim().toLowerCase();if(a!==it.word)errs.push(it)});
  localStorage.setItem(KEY_REVIEW,JSON.stringify(errs.concat(rem)));
  document.getElementById('reviewResult').innerText=`剩余 ${errs.concat(rem).length}`;
}
document.getElementById('loadReviewBtn').onclick=loadReview;
document.getElementById('gradeReviewBtn').onclick=gradeReview;
// TTS
function speak(text){let voices=speechSynthesis.getVoices().filter(v=>v.name.includes('Google')||v.name.includes('Microsoft'));if(!voices.length)voices=speechSynthesis.getVoices();
  let u=new SpeechSynthesisUtterance(text);u.voice=voices[0];u.lang='en-US';u.rate=1;u.pitch=1;speechSynthesis.speak(u);
}
// 初始化
window.onload=renderManage;
</script>
</body>
</html>
