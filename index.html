<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å•è¯ç®¡ç†ä¸é»˜å†™&å¬å†™ç³»ç»Ÿ</title>
  <style>
    body{font-family:sans-serif;margin:0;padding:0;background:#f9f9f9}
    header{background:#4CAF50;color:white;padding:10px;text-align:center}
    nav{display:flex;justify-content:center;background:#333}
    nav button{flex:1;color:white;background:none;border:none;padding:10px;cursor:pointer}
    nav button:hover{background:#575757}
    .container{padding:20px}
    section{display:none}
    section.active{display:block}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f2f2f2}
    textarea{width:100%;height:60px;margin-top:10px}
    .input-word{width:70%;padding:4px;margin-top:4px}
    .btn{margin:10px 0;padding:6px 12px;cursor:pointer}
    .play-btn{margin-right:8px;cursor:pointer}
    .delete-btn{color:red;cursor:pointer}
    ul{padding-left:20px;color:red}
  </style>
</head>
<body>
  <header><h1>å•è¯ç®¡ç†ä¸é»˜å†™&å¬å†™ç³»ç»Ÿ</h1></header>
  <nav>
    <button data-sec="words">å•è¯ç®¡ç†</button>
    <button data-sec="dictate">é»˜å†™ç»ƒä¹ </button>
    <button data-sec="listen">å¬å†™ç»ƒä¹ </button>
    <button data-sec="review">å¤ä¹ ç³»ç»Ÿ</button>
  </nav>
  <div class="container">
    <section id="words" class="active">
      <h2>å•è¯ç®¡ç†</h2>
      <textarea id="bulkInput" placeholder="ç”¨ç©ºæ ¼åˆ†éš”è‹±æ–‡å•è¯"></textarea>
      <button id="bulkAddBtn" class="btn">æ‰¹é‡æ·»åŠ å•è¯</button>
      <table>
        <thead><tr><th>å•è¯</th><th>é‡Šä¹‰</th><th>å¤‡æ³¨</th><th>é»˜å†™</th><th>å¬å†™</th><th>åˆ é™¤</th></tr></thead>
        <tbody id="manageBody"></tbody>
      </table>
    </section>
    <section id="dictate">
      <h2>é»˜å†™ç»ƒä¹ </h2>
      <button id="startDictBtn" class="btn">å¼€å§‹é»˜å†™</button>
      <div id="dictForm"></div>
      <button id="gradeDictBtn" class="btn">æ‰¹æ”¹é»˜å†™</button>
      <div id="dictResult"></div>
    </section>
    <section id="listen">
      <h2>å¬å†™ç»ƒä¹ </h2>
      <button id="startListenBtn" class="btn">å¼€å§‹å¬å†™</button>
      <div id="listenForm"></div>
      <button id="gradeListenBtn" class="btn">æ‰¹æ”¹å¬å†™</button>
      <div id="listenResult"></div>
    </section>
    <section id="review">
      <h2>å¤ä¹ ç³»ç»Ÿ</h2>
      <button id="loadReviewBtn" class="btn">åŠ è½½é”™è¯</button>
      <div id="reviewForm"></div>
      <button id="gradeReviewBtn" class="btn">æ‰¹æ”¹å¤ä¹ </button>
      <div id="reviewResult"></div>
    </section>
  </div>
<script>
  // æœ¬åœ°æ•°æ®æŒä¹…åŒ–é”®
  const KEY_DATA='vocabData',KEY_REVIEW='reviewList';
  // åˆå§‹åŒ–æ•°æ®
  let data = JSON.parse(localStorage.getItem(KEY_DATA) || 'null');
  if (!data) { data = {'2025-08-01':[]}; localStorage.setItem(KEY_DATA, JSON.stringify(data)); }
  function saveData() { localStorage.setItem(KEY_DATA, JSON.stringify(data)); }
  function getList() { return data['2025-08-01']; }

  // åˆ‡æ¢æ¨¡å—
  document.querySelectorAll('nav button').forEach(btn => btn.onclick = () => {
    document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
    document.getElementById(btn.dataset.sec).classList.add('active');
  });

  // Fisherâ€“Yates éšæœºæ‰“ä¹±
  function shuffle(arr) { for (let i = arr.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [arr[i], arr[j]] = [arr[j], arr[i]]; } }

  // æ¸²æŸ“ç®¡ç†è¡¨æ ¼
  function renderManage() {
    const tbody = document.getElementById('manageBody'); tbody.innerHTML = '';
    getList().forEach((it, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.word}</td>
        <td>${it.meaning}</td>
        <td contenteditable onblur="it.note=this.innerText; saveData();">${it.note||''}</td>
        <td><input type="checkbox" ${it.passedDict?'checked':''} onchange="it.passedDict=this.checked; saveData(); changePass('dict', '${it.word}', it.passedDict)"></td>
        <td><input type="checkbox" ${it.passedListen?'checked':''} onchange="it.passedListen=this.checked; saveData(); changePass('listen', '${it.word}', it.passedListen)"></td>
        <td><span class="delete-btn" onclick="getList().splice(${i},1); saveData(); renderManage();">ğŸ—‘ï¸</span></td>`;
      tbody.appendChild(tr);
    });
  }

  // æ‰¹é‡æ·»åŠ ï¼šè‡ªåŠ¨è·å–ä¸­æ–‡é‡Šä¹‰
  async function fetchZh(word) {
    const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=zh-CN&dt=t&q=${encodeURIComponent(word)}`;
    try { const res = await fetch(url); const arr = await res.json(); return arr[0][0][0] || ''; } catch { return ''; }
  }
  document.getElementById('bulkAddBtn').onclick = async () => {
    const btn = document.getElementById('bulkAddBtn'); btn.disabled = true; btn.innerText = 'æ·»åŠ ä¸­...';
    const words = document.getElementById('bulkInput').value.trim().split(/\s+/);
    for (const w of words) {
      if (getList().some(it => it.word === w)) continue;
      let meaning = await fetchZh(w);
      if (!meaning) {
        meaning = prompt(`æœªèƒ½è‡ªåŠ¨è§£æ "${w}" çš„ä¸­æ–‡é‡Šä¹‰ï¼Œè¯·è¾“å…¥:`, '');
        if (!meaning) continue;
      }
      getList().push({word: w, meaning, passedDict: false, passedListen: false});
    }
    saveData(); renderManage();
    btn.innerText = 'æ‰¹é‡æ·»åŠ å•è¯'; btn.disabled = false;
  };

  // startDict
  document.getElementById('startDictBtn').onclick = () => {
    const list = [...getList()]; shuffle(list);
    const form = document.getElementById('dictForm'); form.innerHTML = '';
    list.forEach((it, i) => form.innerHTML += `<div><label>${it.meaning}</label> <input id="d${i}" class="input-word"></div>`);
    form.dataset.list = JSON.stringify(list);
  };
  // gradeDict
  document.getElementById('gradeDictBtn').onclick = () => {
    const list = JSON.parse(document.getElementById('dictForm').dataset.list || '[]');
    let ok = 0, errs = [];
    list.forEach((it, i) => {
      const ans = document.getElementById('d'+i).value.trim().toLowerCase();
      if (ans === it.word.toLowerCase()) ok++; else errs.push({word: it.word, attempt: ans});
      data['2025-08-01'].find(x => x.word === it.word).passedDict = (ans === it.word.toLowerCase());
    });
    saveData(); renderManage(); addToReview(errs);
    let html = `<p>æ­£ç¡® ${ok}/${list.length}</p>`;
    if (errs.length) html += '<ul>' + errs.map(e => `<li>${e.word}: ä½ çš„ "${e.attempt}"</li>`).join('') + '</ul>';
    document.getElementById('dictResult').innerHTML = html;
  };

  // startListen
  document.getElementById('startListenBtn').onclick = () => {
    const list = [...getList()]; shuffle(list);
    const form = document.getElementById('listenForm'); form.innerHTML = '';
    list.forEach((it, i) => form.innerHTML += `<div><button class="play-btn" onclick="speak('${it.word}')">ğŸ”Š</button> <input id="l${i}" class="input-word"></div>`);
    form.dataset.list = JSON.stringify(list);
  };
  // gradeListen
  document.getElementById('gradeListenBtn').onclick = () => {
    const list = JSON.parse(document.getElementById('listenForm').dataset.list || '[]');
    let ok = 0, errs = [];
    list.forEach((it, i) => {
      const ans = document.getElementById('l'+i).value.trim().toLowerCase();
      if (ans === it.word.toLowerCase()) ok++; else errs.push({word: it.word, attempt: ans});
      data['2025-08-01'].find(x => x.word === it.word).passedListen = (ans === it.word.toLowerCase());
    });
    saveData(); renderManage(); addToReview(errs);
    let html = `<p>æ­£ç¡® ${ok}/${list.length}</p>`;
    if (errs.length) html += '<ul>' + errs.map(e => `<li>${e.word}: ä½ çš„ "${e.attempt}"</li>`).join('') + '</ul>';
    document.getElementById('listenResult').innerHTML = html;
  };

  // æ·»åŠ åˆ°å¤ä¹ 
  function addToReview(arr) {
    const lst = JSON.parse(localStorage.getItem(KEY_REVIEW) || '[]');
    localStorage.setItem(KEY_REVIEW, JSON.stringify(lst.concat(arr)));
  }

  document.getElementById('loadReviewBtn').onclick = () => {
    const lst = JSON.parse(localStorage.getItem(KEY_REVIEW) || '[]');
    const form = document.getElementById('reviewForm'); form.innerHTML = '';
    lst.slice(0, 20).forEach((it, i) => form.innerHTML += `<div><button class="play-btn" onclick="speak('${it.word}')">ğŸ”Š</button> ${it.meaning} <input id="r${i}" class="input-word"></div>`);
  };
  document.getElementById('gradeReviewBtn').onclick = () => {
    let lst = JSON.parse(localStorage.getItem(KEY_REVIEW) || '[]');
    const group = lst.slice(0, 20), rem = lst.slice(20), errs = [];
    group.forEach((it, i) => {
      const ans = document.getElementById('r'+i).value.trim().toLowerCase();
      if (ans !== it.word.toLowerCase()) errs.push(it);
    });
    localStorage.setItem(KEY_REVIEW, JSON.stringify(errs.concat(rem)));
    document.getElementById('reviewResult').innerText = `å‰©ä½™ ${errs.concat(rem).length} è¯`;
  };

  // Google TTS
  function speak(text) {
    const url = `https://translate.google.com/translate_tts?ie=UTF-8&tl=en&client=tw-ob&q=${encodeURIComponent(text)}`;
    const audio = new Audio(url);
    audio.play();
  }

  // åˆå§‹åŒ–
  window.onload = () => renderManage();
</script>
</body>
</html>
