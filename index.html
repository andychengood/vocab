<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ¯æ—¥å•è¯ Â· ç®¡ç† / é»˜å†™ / å¬å†™ / å¤ä¹ </title>
  <style>
    body{font-family:sans-serif;margin:0;padding:0;background:#f9f9f9}
    header{background:#4CAF50;color:#fff;text-align:center;padding:10px}
    nav{display:flex;justify-content:center;background:#333}
    nav button{flex:1;padding:10px;border:none;color:#fff;background:none;cursor:pointer}
    nav button:hover{background:#575757}
    .container{padding:20px}
    section{display:none}.active{display:block}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f2f2f2}
    textarea{width:100%;height:60px;margin-top:10px}
    .input-word{width:70%;padding:4px;margin-top:4px}
    .btn{margin:10px 0;padding:6px 12px;cursor:pointer}
    .play{margin-right:6px;cursor:pointer}
    .del{color:red;cursor:pointer}
    ul{padding-left:20px;color:red}
  </style>
</head>
<body>
<header><h1>æ¯æ—¥å•è¯ Â· ç®¡ç† / é»˜å†™ / å¬å†™ / å¤ä¹ </h1></header>
<nav>
  <button data-sec="manage">å•è¯ç®¡ç†</button>
  <button data-sec="dict">é»˜å†™ç»ƒä¹ </button>
  <button data-sec="listen">å¬å†™ç»ƒä¹ </button>
  <button data-sec="review">å¤ä¹ ç³»ç»Ÿ</button>
</nav>

<div class="container">
  <!-- ç®¡ç† -->
  <section id="manage" class="active">
    <h2>å•è¯ç®¡ç†</h2>
    <label>æ—¥æœŸ:
      <input type="date" id="datePicker"/>
    </label>
    <textarea id="bulkInput" placeholder="ç”¨ç©ºæ ¼åˆ†éš”è‹±æ–‡å•è¯"></textarea>
    <button id="bulkBtn" class="btn">æ‰¹é‡æ·»åŠ å•è¯</button>
    <table>
      <thead>
        <tr><th>å•è¯</th><th>ä¸­æ–‡é‡Šä¹‰</th><th>å¤‡æ³¨</th><th>é»˜å†™</th><th>å¬å†™</th><th>åˆ é™¤</th></tr>
      </thead>
      <tbody id="manageBody"></tbody>
    </table>
  </section>

  <!-- é»˜å†™ -->
  <section id="dict">
    <h2>é»˜å†™ç»ƒä¹ </h2>
    <label>é€‰æ‹©æ—¥æœŸ:
      <input type="date" id="dictDate"/>
    </label>
    <button id="startDict" class="btn">å¼€å§‹é»˜å†™</button>
    <div id="dictForm"></div>
    <button id="gradeDict" class="btn">æ‰¹æ”¹é»˜å†™</button>
    <div id="dictResult"></div>
  </section>

  <!-- å¬å†™ -->
  <section id="listen">
    <h2>å¬å†™ç»ƒä¹ </h2>
    <label>é€‰æ‹©æ—¥æœŸ:
      <input type="date" id="listenDate"/>
    </label>
    <button id="startListen" class="btn">å¼€å§‹å¬å†™</button>
    <div id="listenForm"></div>
    <button id="gradeListen" class="btn">æ‰¹æ”¹å¬å†™</button>
    <div id="listenResult"></div>
  </section>

  <!-- å¤ä¹  -->
  <section id="review">
    <h2>å¤ä¹ ç³»ç»Ÿ</h2>
    <button id="loadReview" class="btn">åŠ è½½é”™è¯</button>
    <div id="reviewForm"></div>
    <button id="gradeReview" class="btn">æ‰¹æ”¹å¤ä¹ </button>
    <div id="reviewResult"></div>
  </section>
</div>

<script>
/* ---------- æŒä¹…åŒ– ---------- */
const KEY_DATA='vocab_by_date', KEY_REVIEW='review_list';
let data = JSON.parse(localStorage.getItem(KEY_DATA)||'{}');
function save(){ localStorage.setItem(KEY_DATA,JSON.stringify(data)); }
function listBy(date){ return data[date] || []; }

/* ---------- å·¥å…· ---------- */
function $(id){ return document.getElementById(id); }
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}}
async function zh(word){
  const url=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=zh-CN&dt=t&q=${encodeURIComponent(word)}`;
  try{const r=await fetch(url);const j=await r.json();return j[0][0][0]}catch{return '';}
}
function tts(word){
  const u=`https://translate.google.com/translate_tts?ie=UTF-8&tl=en&client=tw-ob&q=${encodeURIComponent(word)}`;
  fetch(u).then(r=>r.blob()).then(b=>{
    const url=URL.createObjectURL(b); const a=new Audio(url); a.onended=()=>URL.revokeObjectURL(url); a.play();
  }).catch(()=>{ const s=new SpeechSynthesisUtterance(word); speechSynthesis.speak(s); });
}
/* ---------- åˆ‡æ¢ ---------- */
document.querySelectorAll('nav button').forEach(btn=>btn.onclick=()=>{
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  $(btn.dataset.sec).classList.add('active');
});
/* ---------- æ—¥æœŸé»˜è®¤å€¼ ---------- */
const today = new Date().toISOString().slice(0,10);
['datePicker','dictDate','listenDate'].forEach(id=>$(id).value=today);
if(!data[today]) data[today]=[];
save();

/* ---------- ç®¡ç†è¡¨ ---------- */
function renderManage(){
  const d=$('datePicker').value; if(!data[d]) data[d]=[];
  const body=$('manageBody'); body.innerHTML='';
  listBy(d).forEach((it,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.word}</td><td>${it.mean}</td>
      <td contenteditable onblur="data['${d}'][${i}].note=this.innerText;save();">${it.note||''}</td>
      <td><input type=checkbox ${it.d?'checked':''} onchange="data['${d}'][${i}].d=this.checked;save();"></td>
      <td><input type=checkbox ${it.l?'checked':''} onchange="data['${d}'][${i}].l=this.checked;save();"></td>
      <td><span class="del" onclick="data['${d}'].splice(${i},1);save();renderManage();">ğŸ—‘ï¸</span></td>`;
    body.appendChild(tr);
  });
}
$('datePicker').onchange=renderManage;
renderManage();

/* ---------- æ‰¹é‡æ·»åŠ  ---------- */
$('bulkBtn').onclick=async()=>{
  const d=$('datePicker').value; const txt=$('bulkInput').value.trim();
  if(!txt) return;
  const ws=txt.split(/\\s+/);
  for(const w of ws){
    if(listBy(d).some(x=>x.word===w)) continue;
    let mean=await zh(w);
    if(!mean) {mean=prompt(`\"${w}\" ä¸­æ–‡ï¼Ÿ`,''); if(!mean) continue;}
    listBy(d).push({word:w,mean});
  }
  save(); renderManage(); $('bulkInput').value='';
};

/* ---------- é»˜å†™ ---------- */
$('startDict').onclick=()=>{
  const d=$('dictDate').value, arr=[...listBy(d)]; shuffle(arr);
  const f=$('dictForm'); f.innerHTML=''; arr.forEach((it,i)=>f.innerHTML+=`<div>${it.mean}<input id="d${i}" class="input-word"></div>`); f.dataset.l=JSON.stringify(arr);
};
$('gradeDict').onclick=()=>{
  const arr=JSON.parse($('dictForm').dataset.l||'[]'), d=$('dictDate').value, errs=[];
  let ok=0; arr.forEach((it,i)=>{const a=$('d'+i).value.trim().toLowerCase(); if(a===it.word.toLowerCase()){ok++; it.d=true;}else{it.d=false; errs.push(it);} });
  save(); renderManage(); addReview(errs);
  $('dictResult').innerHTML=`<p>æ­£ç¡® ${ok}/${arr.length}</p>`+(errs.length?'<ul>'+errs.map(e=>`<li>${e.word}</li>`).join('')+'</ul>':'');
};

/* ---------- å¬å†™ ---------- */
$('startListen').onclick=()=>{
  const d=$('listenDate').value, arr=[...listBy(d)]; shuffle(arr);
  const f=$('listenForm'); f.innerHTML=''; arr.forEach((it,i)=>f.innerHTML+=`<div><button class="play" onclick="tts('${it.word}')">ğŸ”Š</button><input id="l${i}" class="input-word"></div>`); f.dataset.l=JSON.stringify(arr);
};
$('gradeListen').onclick=()=>{
  const arr=JSON.parse($('listenForm').dataset.l||'[]'), d=$('listenDate').value, errs=[]; let ok=0;
  arr.forEach((it,i)=>{const a=$('l'+i).value.trim().toLowerCase(); if(a===it.word.toLowerCase()){ok++; it.l=true;}else{it.l=false; errs.push(it);} });
  save(); renderManage(); addReview(errs);
  $('listenResult').innerHTML=`<p>æ­£ç¡® ${ok}/${arr.length}</p>`+(errs.length?'<ul>'+errs.map(e=>`<li>${e.word}</li>`).join('')+'</ul>':'');
};

/* ---------- å¤ä¹  ---------- */
function addReview(errs){ if(!errs.length) return;
  const lst=JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]'); localStorage.setItem(KEY_REVIEW,JSON.stringify(lst.concat(errs)));
}
$('loadReview').onclick=()=>{
  const lst=JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]'); const f=$('reviewForm'); f.innerHTML='';
  lst.slice(0,20).forEach((it,i)=>f.innerHTML+=`<div><button class="play" onclick="tts('${it.word}')">ğŸ”Š</button>${it.mean}<input id="r${i}" class="input-word"></div>`);
};
$('gradeReview').onclick=()=>{
  let lst=JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');
  const grp=lst.slice(0,20), remain=lst.slice(20), errs=[];
  grp.forEach((it,i)=>{const a=$('r'+i).value.trim().toLowerCase(); if(a!==it.word.toLowerCase()) errs.push(it);});
  localStorage.setItem(KEY_REVIEW,JSON.stringify(errs.concat(remain)));
  $('reviewResult').innerText=`å‰©ä½™ ${errs.concat(remain).length} è¯`;
};
</script>
</body>
</html>
