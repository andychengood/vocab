<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å•è¯ç®¡ç†ä¸é»˜å†™&å¬å†™ç³»ç»Ÿ</title>
  <style>
    body{font-family:sans-serif;margin:0;padding:0;background:#f9f9f9}
    header{background:#4CAF50;color:#fff;padding:10px;text-align:center}
    nav{display:flex;justify-content:center;background:#333}
    nav button{background:none;border:none;color:#fff;padding:12px 16px;cursor:pointer}
    nav button:hover{background:#575757}
    .container{padding:20px}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f2f2f2}
    .input-word{width:80%;padding:4px}
    .btn{margin-top:10px;padding:6px 12px;cursor:pointer}
    .play-btn{margin-right:8px;cursor:pointer}
    textarea{width:100%;height:60px;margin-top:10px}
    .delete-btn{color:red;cursor:pointer}
  </style>
</head>
<body>
  <header><h1>å•è¯ç®¡ç†ä¸é»˜å†™&å¬å†™ç³»ç»Ÿ</h1></header>
  <nav>
    <button onclick="showSection('words')">å•è¯ç®¡ç†</button>
    <button onclick="showSection('dictate')">é»˜å†™ç»ƒä¹ </button>
    <button onclick="showSection('listen')">å¬å†™ç»ƒä¹ </button>
    <button onclick="showSection('review')">å¤ä¹ ç³»ç»Ÿ</button>
  </nav>
  <div class="container">
    <!-- å•è¯ç®¡ç† -->
    <section id="words">
      <h2>å•è¯ç®¡ç†</h2>
      <p>æ‰¹é‡æ·»åŠ è‹±æ–‡å•è¯ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æŠ“å–ä¸­æ–‡é‡Šä¹‰ï¼š</p>
      <textarea id="bulkInput" placeholder="è¾“å…¥å¤šä¸ªè‹±æ–‡å•è¯ï¼Œç”¨ç©ºæ ¼åˆ†éš”"></textarea>
      <button class="btn" onclick="bulkAdd()">æ‰¹é‡æ·»åŠ å•è¯</button>
      <table id="wordManageTable">
        <thead>
          <tr>
            <th>å•è¯</th><th>ä¸­æ–‡é‡Šä¹‰</th><th>å¤‡æ³¨/ç¬”è®°</th>
            <th>é»˜å†™é€šè¿‡</th><th>å¬å†™é€šè¿‡</th><th>åˆ é™¤</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
    <!-- é»˜å†™ç»ƒä¹  -->
    <section id="dictate" class="hidden">
      <h2>é»˜å†™ç»ƒä¹ </h2>
      <label>é€‰æ‹©æ—¥æœŸ:
        <select id="dictDate"></select>
      </label>
      <div id="dictForm"></div>
      <button class="btn" onclick="gradeDictation()">å®Œæˆå¹¶æ‰¹æ”¹</button>
      <div id="dictResult"></div>
      <h3>å†å²æˆç»©</h3><div id="dictStats"></div>
    </section>
    <!-- å¬å†™ç»ƒä¹  -->
    <section id="listen" class="hidden">
      <h2>å¬å†™ç»ƒä¹ </h2>
      <label>é€‰æ‹©æ—¥æœŸ:
        <select id="listenDate"></select>
      </label>
      <div id="listenForm"></div>
      <button class="btn" onclick="gradeListening()">å®Œæˆå¹¶æ‰¹æ”¹</button>
      <div id="listenResult"></div>
      <h3>å†å²æˆç»©</h3><div id="listenStats"></div>
    </section>
    <!-- å¤ä¹ ç³»ç»Ÿ -->
    <section id="review" class="hidden">
      <h2>å¤ä¹ ç³»ç»Ÿ</h2>
      <button class="btn" onclick="loadReview()">åŠ è½½é”™è¯ç»„</button>
      <div id="reviewForm"></div>
      <button class="btn" onclick="gradeReview()">æäº¤å¤ä¹ </button>
      <div id="reviewResult"></div>
    </section>
  </div>
  <script>
    // åˆå§‹åŒ–æ•°æ®ç»“æ„
    const KEY_DATA   = 'vocabData';
    const KEY_DICT   = 'dictRecords';
    const KEY_LISTEN = 'listenRecords';
    const KEY_REVIEW = 'reviewList';
    // é»˜è®¤å•è¯æ•°æ®ï¼Œä»…åœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶åˆå§‹åŒ–
    const defaultData = {
      '2025-08-01': [
        {word:'instinctively',meaning:'æœ¬èƒ½åœ°'},
        {word:'sheer',meaning:'å®Œå…¨çš„ï¼›é™¡å³­çš„ï¼›ç»å¯¹çš„'},
        /* â€¦ æ­¤å¤„å¯ä¿ç•™é»˜è®¤ 39 æ¡ â€¦ */
        {word:'would they not',meaning:'ä»–ä»¬éš¾é“ä¸ä¼š...å—ï¼Ÿ'}
      ]
    };
    // ä» localStorage è¯»å–æˆ–é¦–æ¬¡åˆå§‹åŒ–
    let data = {};

    function loadData(){
      const stored = JSON.parse(localStorage.getItem(KEY_DATA)||'null');
      if(stored){
        data = stored;
      } else {
        data = defaultData;
        saveData();
      }
    }');
      data = Object.keys(d).length?d:{'2025-08-01':[]};
    }
    function saveData(){
      localStorage.setItem(KEY_DATA, JSON.stringify(data));
    }
    function getToday(){ return Object.keys(data)[0]; }
    
    // æ¸²æŸ“ç®¡ç†è¡¨æ ¼
    function renderWords(){
      const tbody = document.querySelector('#wordManageTable tbody');
      tbody.innerHTML = '';
      data[getToday()].forEach((item,i)=>{
        const tr = document.createElement('tr');
        const note = localStorage.getItem(`note_${item.word}`) || '';
        tr.innerHTML = `
          <td>${item.word}</td>
          <td>${item.meaning}</td>
          <td contenteditable onblur="saveNote('${item.word}',this.innerText)">${note}</td>
          <td><input type='checkbox' ${item.passedDict?'checked':''} onchange="togglePass('dict',${i},this.checked)"></td>
          <td><input type='checkbox' ${item.passedListen?'checked':''} onchange="togglePass('listen',${i},this.checked)"></td>
          <td><span class='delete-btn' onclick='deleteWord(${i})'>ğŸ—‘ï¸</span></td>
        `;
        tbody.appendChild(tr);
      });
    }
    function saveNote(w,t){ localStorage.setItem(`note_${w}`,t); }
    function togglePass(type,index,val){
      const list = data[getToday()];
      if(type==='dict') list[index].passedDict = val;
      else list[index].passedListen = val;
      saveData();
    }
    function deleteWord(index){
      if(confirm('ç¡®è®¤åˆ é™¤ '+data[getToday()][index].word+'?')){
        data[getToday()].splice(index,1);
        saveData(); renderWords();
      }
    }

    // æ‰¹é‡æ·»åŠ ï¼Œå»é‡ & è‡ªåŠ¨æŠ“é‡Šä¹‰ & é”™è¯é‡æ–°è¾“å…¥
    async function bulkAdd(){
      const words = document.getElementById('bulkInput').value.trim().split(/\s+/);
      const list = data[getToday()];
      for(const w of words){
        if(list.find(it=>it.word===w)) continue; // å»é‡
        let meaning = '';
        try{
          const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${w}`);
          const j = await res.json();
          meaning = j[0]?.meanings[0]?.definitions[0]?.definition || '';
        }catch{ meaning=''; }
        if(!meaning){
          meaning = prompt(`æœªæ‰¾åˆ°é‡Šä¹‰ï¼Œè¯·æ‰‹åŠ¨è¾“å…¥ "${w}" çš„ä¸­æ–‡é‡Šä¹‰:`,'');
          if(!meaning) continue;
        }
        list.push({word:w,meaning,passedDict:false,passedListen:false});
      }
      saveData(); renderWords();
    }

    // æ¨¡å—åˆ‡æ¢
    function showSection(id){
      ['words','dictate','listen','review'].forEach(s=>{
        document.getElementById(s).classList.toggle('hidden',s!==id);
      });
      if(id==='dictate') buildDictForm();
      if(id==='listen') buildListenForm();
      if(id==='review') loadReview();
    }

    // é»˜å†™
    function buildDictForm(){
      const sel = document.getElementById('dictDate'); sel.innerHTML='';
      Object.keys(data).forEach(d=>sel.add(new Option(d,d)));
      const d = sel.value, form = document.getElementById('dictForm'); form.innerHTML='';
      data[d].forEach((it,i)=>{
        form.innerHTML += `<div><label>${it.meaning}</label>
          <input id='d${i}' class='input-word'></div>`;
      });
    }
    function gradeDictation(){
      const d = document.getElementById('dictDate').value;
      const rec = JSON.parse(localStorage.getItem(KEY_DICT)||'[]');
      let ok = 0;
      const errs = [];
      data[d].forEach((it,i) => {
        const ans = document.getElementById('d'+i).value.trim();
        if(ans.toLowerCase() === it.word.toLowerCase()) {
          ok++;
        } else {
          errs.push({
            word: it.word,
            attempt: ans,
            meaning: it.meaning
          });
        }
      });
      rec.push({date:d, total:data[d].length, correct:ok, errors: errs});
      localStorage.setItem(KEY_DICT, JSON.stringify(rec));
      // Display result
      let resultHTML = `<p>${d}ï¼š${ok}/${data[d].length}</p>`;
      if(errs.length){
        resultHTML += '<ul style="color:red">';
        errs.forEach(e => {
          resultHTML += `<li>å•è¯: ${e.word}ï¼Œä½ çš„ç­”æ¡ˆ: ${e.attempt}ï¼Œæ­£ç¡®ç­”æ¡ˆ: ${e.word}</li>`;
        });
        resultHTML += '</ul>';
      }
      document.getElementById('dictResult').innerHTML = resultHTML;
      loadDictStats();
      addToReview(errs);
    });
      rec.push({date:d,total:data[d].length,correct:ok});
      localStorage.setItem(KEY_DICT,JSON.stringify(rec));
      addToReview(errs);
      document.getElementById('dictResult').innerText=`${d}ï¼š${ok}/${data[d].length}`;
      loadDictStats();
    }
    function loadDictStats(){
      const rec = JSON.parse(localStorage.getItem(KEY_DICT)||'[]');
      document.getElementById('dictStats').innerHTML = 
        rec.map(r=>`<p>${r.date} ${r.correct}/${r.total}</p>`).join('');
    }

    // å¬å†™
    function buildListenForm(){
      const sel = document.getElementById('listenDate'); sel.innerHTML='';
      Object.keys(data).forEach(d=>sel.add(new Option(d,d)));
      const d = sel.value, form = document.getElementById('listenForm'); form.innerHTML='';
      data[d].forEach((it,i)=>{
        form.innerHTML += `<div>
          <button class='play-btn' onclick="speak('${it.word}')">ğŸ”Š</button>
          <input id='l${i}' class='input-word' placeholder='å¬å†™è‹±æ–‡'></div>`;
      });
    }
    function gradeListening(){
      const d = document.getElementById('listenDate').value;
      const rec = JSON.parse(localStorage.getItem(KEY_LISTEN)||'[]');
      let ok = 0;
      const errs = [];
      data[d].forEach((it,i) => {
        const ans = document.getElementById('l'+i).value.trim();
        if(ans.toLowerCase() === it.word.toLowerCase()) {
          ok++;
        } else {
          errs.push({
            word: it.word,
            attempt: ans,
            meaning: it.meaning
          });
        }
      });
      rec.push({date:d, total:data[d].length, correct:ok, errors: errs});
      localStorage.setItem(KEY_LISTEN, JSON.stringify(rec));
      // Display result
      let resultHTML = `<p>${d}ï¼š${ok}/${data[d].length}</p>`;
      if(errs.length){
        resultHTML += '<ul style="color:red">';
        errs.forEach(e => {
          resultHTML += `<li>å•è¯: ${e.word}ï¼Œä½ çš„ç­”æ¡ˆ: ${e.attempt}ï¼Œæ­£ç¡®ç­”æ¡ˆ: ${e.word}</li>`;
        });
        resultHTML += '</ul>';
      }
      document.getElementById('listenResult').innerHTML = resultHTML;
      loadListenStats();
      addToReview(errs);
    });
      rec.push({date:d,total:data[d].length,correct:ok});
      localStorage.setItem(KEY_LISTEN,JSON.stringify(rec));
      addToReview(errs);
      document.getElementById('listenResult').innerText=`${d}ï¼š${ok}/${data[d].length}`;
      loadListenStats();
    }
    function loadListenStats(){
      const rec = JSON.parse(localStorage.getItem(KEY_LISTEN)||'[]');
      document.getElementById('listenStats').innerHTML = 
        rec.map(r=>`<p>${r.date} ${r.correct}/${r.total}</p>`).join('');
    }

    // å¤ä¹ 
    function addToReview(arr){
      const list = JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');
      localStorage.setItem(KEY_REVIEW,JSON.stringify(list.concat(arr)));
    }
    function loadReview(){
      const list = JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');
      const form = document.getElementById('reviewForm'); form.innerHTML='';
      list.slice(0,20).forEach((it,i)=>{
        form.innerHTML += `<div>
          <button class='play-btn' onclick="speak('${it.word}')">ğŸ”Š</button>
          <label>${it.meaning}</label>
          <input id='r${i}' class='input-word'></div>`;
      });
    }
    function gradeReview(){
      let list = JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');
      const group = list.slice(0,20), remain=list.slice(20), errs=[];
      group.forEach((it,i)=>{
        const ans = document.getElementById('r'+i).value.trim().toLowerCase();
        if(ans!==it.word) errs.push(it);
      });
      localStorage.setItem(KEY_REVIEW,JSON.stringify(errs.concat(remain)));
      document.getElementById('reviewResult').innerText=`å‰©ä½™${errs.concat(remain).length}è¯`;
    }

    // æœ—è¯»
    function speak(text) {
      // é€‰æ‹©æ›´è‡ªç„¶çš„äººå£°
      const voices = speechSynthesis.getVoices().filter(v => v.lang.startsWith('en') && /Google|Microsoft/.test(v.name));
      const utter = new SpeechSynthesisUtterance(text);
      if (voices.length) {
        utter.voice = voices[0];  // é€‰æ‹©ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„é«˜è´¨é‡äººå£°
      }
      utter.pitch = 1;
      utter.rate = 1;
      speechSynthesis.speak(utter);
    }
