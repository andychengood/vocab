<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å•è¯ç®¡ç†ä¸é»˜å†™&å¬å†™ç³»ç»Ÿ</title>
  <style>
    body{font-family:sans-serif;margin:0;padding:0;background:#f9f9f9}
    header{background:#4CAF50;color:white;padding:10px;text-align:center}
    nav{display:flex;justify-content:center;background:#333}
    nav button{flex:1;color:white;background:none;border:none;padding:10px;cursor:pointer}
    nav button:hover{background:#575757}
    .container{padding:20px}
    section{display:none}
    section.active{display:block}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f2f2f2}
    textarea{width:100%;height:60px;margin-top:10px}
    .input-word{width:70%;padding:4px;margin-top:4px}
    .btn{margin:10px 0;padding:6px 12px;cursor:pointer}
    .play-btn{margin-right:8px;cursor:pointer}
    .delete-btn{color:red;cursor:pointer}
    ul{padding-left:20px;color:red}
  </style>
</head>
<body>
  <header><h1>å•è¯ç®¡ç†ä¸é»˜å†™&å¬å†™ç³»ç»Ÿ</h1></header>
  <nav>
    <button data-sec="words">å•è¯ç®¡ç†</button>
    <button data-sec="dictate">é»˜å†™ç»ƒä¹ </button>
    <button data-sec="listen">å¬å†™ç»ƒä¹ </button>
    <button data-sec="review">å¤ä¹ ç³»ç»Ÿ</button>
  </nav>
  <div class="container">
    <section id="words" class="active">
      <h2>å•è¯ç®¡ç†</h2>
      <textarea id="bulkInput" placeholder="ç”¨ç©ºæ ¼åˆ†éš”è‹±æ–‡å•è¯"></textarea>
      <button id="bulkAddBtn" class="btn">æ‰¹é‡æ·»åŠ å•è¯</button>
      <table>
        <thead><tr><th>å•è¯</th><th>é‡Šä¹‰</th><th>å¤‡æ³¨</th><th>é»˜å†™é€šè¿‡</th><th>å¬å†™é€šè¿‡</th><th>åˆ é™¤</th></tr></thead>
        <tbody id="manageBody"></tbody>
      </table>
    </section>
    <section id="dictate">
      <h2>é»˜å†™ç»ƒä¹ </h2>
      <button id="startDictBtn" class="btn">å¼€å§‹é»˜å†™</button>
      <div id="dictForm"></div>
      <button id="gradeDictBtn" class="btn">æ‰¹æ”¹é»˜å†™</button>
      <div id="dictResult"></div>
    </section>
    <section id="listen">
      <h2>å¬å†™ç»ƒä¹ </h2>
      <button id="startListenBtn" class="btn">å¼€å§‹å¬å†™</button>
      <div id="listenForm"></div>
      <button id="gradeListenBtn" class="btn">æ‰¹æ”¹å¬å†™</button>
      <div id="listenResult"></div>
    </section>
    <section id="review">
      <h2>å¤ä¹ ç³»ç»Ÿ</h2>
      <button id="loadReviewBtn" class="btn">åŠ è½½é”™è¯</button>
      <div id="reviewForm"></div>
      <button id="gradeReviewBtn" class="btn">æ‰¹æ”¹å¤ä¹ </button>
      <div id="reviewResult"></div>
    </section>
  </div>
<script>
  // æ•°æ®å’ŒæŒä¹…åŒ–
  const KEY='vocabData',KEY_REVIEW='reviewList';
  let data = JSON.parse(localStorage.getItem(KEY)||'null');
  if(!data){data={'2025-08-01':[]};localStorage.setItem(KEY,JSON.stringify(data));}
  function save(){localStorage.setItem(KEY,JSON.stringify(data));}
  function getList(){return data['2025-08-01'];}
  // åˆ‡æ¢æ¨¡å—
  document.querySelectorAll('nav button').forEach(b=>b.onclick=()=>{
    document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
    document.getElementById(b.dataset.sec).classList.add('active');
  });
  // Fisherâ€“Yates shuffle
  function shuffle(arr){for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}}
  // æ¸²æŸ“ç®¡ç†
  function renderManage(){const body=document.getElementById('manageBody');body.innerHTML='';getList().forEach((it,i)=>{
    const tr=document.createElement('tr');tr.innerHTML=
      `<td>${it.word}</td><td>${it.meaning}</td>`+
      `<td contenteditable onblur="it.note=this.innerText;save();">${it.note||''}</td>`+
      `<td><input type=checkbox ${it.passedDict?'checked':''} onchange="it.passedDict=this.checked;save();"></td>`+
      `<td><input type=checkbox ${it.passedListen?'checked':''} onchange="it.passedListen=this.checked;save();"></td>`+
      `<td><span class=delete-btn onclick="getList().splice(${i},1);save();renderManage();">ğŸ—‘ï¸</span></td>`;
    body.appendChild(tr);
  });}
  // æ‰¹é‡æ·»åŠ ï¼Œå«ä¸­æ–‡API
  document.getElementById('bulkAddBtn').onclick=async()=>{
    const btn=document.getElementById('bulkAddBtn');btn.disabled=true;btn.innerText='æ·»åŠ ä¸­...';
    const words=document.getElementById('bulkInput').value.trim().split(/\s+/);
    for(const w of words){if(getList().some(it=>it.word===w))continue;
      let meaning='';
      try{const r=await fetch(`https://api.shanbay.com/bdc/search/?word=${w}`);const j=await r.json();meaning=j.data?.cn_definition||'';}catch{}
      if(!meaning){meaning=''; try{const r2=await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${w}`);const j2=await r2.json();meaning=j2[0]?.meanings[0]?.definitions[0]?.definition||'';}catch{}
        if(!meaning){const m=prompt(`æœªæ‰¾åˆ° "${w}" é‡Šä¹‰ï¼Œè¯·è¾“å…¥:`,'');if(!m)continue;meaning=m;}}
      getList().push({word:w,meaning,passedDict:false,passedListen:false});
    }
    save();renderManage();btn.innerText='æ‰¹é‡æ·»åŠ å•è¯';btn.disabled=false;
  };
  // é»˜å†™
  document.getElementById('startDictBtn').onclick=()=>{
    const list=getList().slice();shuffle(list);
    const form=document.getElementById('dictForm');form.innerHTML='';list.forEach((it,i)=>form.innerHTML+=`<div><label>${it.meaning}</label><input id=d${i} class=input-word></div>`);
    form.dataset.words=JSON.stringify(list);
  };
  document.getElementById('gradeDictBtn').onclick=()=>{
    const list=JSON.parse(document.getElementById('dictForm').dataset.words||'[]');let ok=0,errs=[];
    list.forEach((it,i)=>{const a=document.getElementById('d'+i).value.trim().toLowerCase();if(a===it.word.toLowerCase()){ok++;it.passedDict=true}else{errs.push({word:it.word,attempt:a});it.passedDict=false}});
    save();renderManage();addToReview(errs);
    let r=`<p>æ­£ç¡® ${ok}/${list.length}</p>`;if(errs.length)r+='<ul>'+errs.map(e=>`<li>${e.word}: ä½ çš„ "${e.attempt}"</li>`).join('')+'</ul>';
    document.getElementById('dictResult').innerHTML=r;
  };
  // å¬å†™
  document.getElementById('startListenBtn').onclick=()=>{
    const list=getList().slice();shuffle(list);
    const form=document.getElementById('listenForm');form.innerHTML='';list.forEach((it,i)=>form.innerHTML+=`<div><button class=play-btn onclick="speak('${it.word}')">ğŸ”Š</button><input id=l${i} class=input-word></div>`);
    form.dataset.words=JSON.stringify(list);
  };
  document.getElementById('gradeListenBtn').onclick=()=>{
    const list=JSON.parse(document.getElementById('listenForm').dataset.words||'[]');let ok=0,errs=[];
    list.forEach((it,i)=>{const a=document.getElementById('l'+i).value.trim().toLowerCase();if(a===it.word.toLowerCase()){ok++;it.passedListen=true}else{errs.push({word:it.word,attempt:a});it.passedListen=false}});
    save();renderManage();addToReview(errs);
    let r=`<p>æ­£ç¡® ${ok}/${list.length}</p>`;if(errs.length)r+='<ul>'+errs.map(e=>`<li>${e.word}: ä½ çš„ "${e.attempt}"</li>`).join('')+'</ul>';
    document.getElementById('listenResult').innerHTML=r;
  };
  // å¤ä¹ 
  function addToReview(arr){const lst=JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');localStorage.setItem(KEY_REVIEW,JSON.stringify(lst.concat(arr)));}
  document.getElementById('loadReviewBtn').onclick=()=>{
    const lst=JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');const f=document.getElementById('reviewForm');f.innerHTML='';lst.slice(0,20).forEach((it,i)=>f.innerHTML+=`<div><button class=play-btn onclick="speak('${it.word}')">ğŸ”Š</button><label>${it.meaning}</label><input id=r${i} class=input-word></div>`);
  };
  document.getElementById('gradeReviewBtn').onclick=()=>{
    let lst=JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');let errs=[],grp=lst.slice(0,20),rem=lst.slice(20);
    grp.forEach((it,i)=>{const a=document.getElementById('r'+i).value.trim().toLowerCase();if(a!==it.word)errs.push(it)});
    localStorage.setItem(KEY_REVIEW,JSON.stringify(errs.concat(rem)));
    document.getElementById('reviewResult').innerText=`å‰©ä½™ ${errs.concat(rem).length}`;
  };
  // äººå£°æœ—è¯»
  function speak(text){let vs=speechSynthesis.getVoices().filter(v=>v.lang==='en-US');if(!vs.length)vs=speechSynthesis.getVoices();let u=new SpeechSynthesisUtterance(text);u.voice=vs[0];u.rate=1;u.pitch=1;speechSynthesis.speak(u);}  
  // åˆå§‹åŒ–æ¸²æŸ“
  window.onload=renderManage;
</script>
</body>
</html>
