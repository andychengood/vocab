<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å•è¯ç®¡ç†ä¸é»˜å†™&å¬å†™ç³»ç»Ÿ</title>
  <style>
    body{font-family:sans-serif;margin:0;padding:0;background:#f9f9f9}
    header{background:#4CAF50;color:#fff;padding:10px;text-align:center}
    nav{display:flex;justify-content:center;background:#333}
    nav button{background:none;border:none;color:#fff;padding:12px 16px;cursor:pointer}
    nav button:hover{background:#575757}
    .container{padding:20px}
    .hidden{display:none}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;text-align:left}
    th{background:#f2f2f2}
    .input-word{width:80%;padding:4px}
    .btn{margin-top:10px;padding:6px 12px;cursor:pointer}
    .play-btn{margin-right:8px;cursor:pointer}
    textarea{width:100%;height:60px;margin-top:10px}
  </style>
</head>
<body>
  <header><h1>å•è¯ç®¡ç†ä¸é»˜å†™&å¬å†™ç³»ç»Ÿ</h1></header>
  <nav>
    <button onclick="showSection('words')">å•è¯ç®¡ç†</button>
    <button onclick="showSection('dictate')">é»˜å†™ç»ƒä¹ </button>
    <button onclick="showSection('listen')">å¬å†™ç»ƒä¹ </button>
    <button onclick="showSection('review')">å¤ä¹ ç³»ç»Ÿ</button>
  </nav>
  <div class="container">
    <!-- å•è¯ç®¡ç† -->
    <section id="words">
      <h2>å•è¯ç®¡ç†</h2>
      <p>æ‰¹é‡æ·»åŠ è‹±æ–‡å•è¯ï¼ˆç©ºæ ¼åˆ†éš”ï¼‰ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æŠ“å–ä¸­æ–‡é‡Šä¹‰ï¼š</p>
      <textarea id="bulkInput" placeholder="è¾“å…¥å¤šä¸ªè‹±æ–‡å•è¯ï¼Œç”¨ç©ºæ ¼åˆ†éš”"></textarea>
      <button class="btn" onclick="bulkAdd()">æ‰¹é‡æ·»åŠ å•è¯</button>
      <table id="wordManageTable">
        <thead>
          <tr><th>å•è¯</th><th>ä¸­æ–‡é‡Šä¹‰</th><th>å¤‡æ³¨/ç¬”è®°</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
    <!-- é»˜å†™ç»ƒä¹  -->
    <section id="dictate" class="hidden">
      <h2>é»˜å†™ç»ƒä¹ </h2>
      <label>é€‰æ‹©æ—¥æœŸ:
        <select id="dictDate"></select>
      </label>
      <div id="dictForm"></div>
      <button class="btn" onclick="gradeDictation()">å®Œæˆå¹¶æ‰¹æ”¹</button>
      <div id="dictResult"></div>
      <h3>å†å²æˆç»©</h3>
      <div id="dictStats"></div>
    </section>
    <!-- å¬å†™ç»ƒä¹  -->
    <section id="listen" class="hidden">
      <h2>å¬å†™ç»ƒä¹ </h2>
      <label>é€‰æ‹©æ—¥æœŸ:
        <select id="listenDate"></select>
      </label>
      <div id="listenForm"></div>
      <button class="btn" onclick="gradeListening()">å®Œæˆå¹¶æ‰¹æ”¹</button>
      <div id="listenResult"></div>
      <h3>å†å²æˆç»©</h3>
      <div id="listenStats"></div>
    </section>
    <!-- å¤ä¹ ç³»ç»Ÿ -->
    <section id="review" class="hidden">
      <h2>å¤ä¹ ç³»ç»Ÿ</h2>
      <button class="btn" onclick="loadReview()">åŠ è½½é”™è¯ç»„</button>
      <div id="reviewForm"></div>
      <button class="btn" onclick="gradeReview()">æäº¤å¤ä¹ </button>
      <div id="reviewResult"></div>
    </section>
  </div>
  <script>
    // æ—¥æœŸå¯¹åº”çš„å•è¯æ•°æ®ç¤ºä¾‹ï¼Œåç»­å¯åŠ¨æ€æ‰©å±•
    let data = {
      '2025-08-01': [
        {word:'instinctively',meaning:'æœ¬èƒ½åœ°'},
        {word:'sheer',      meaning:'å®Œå…¨çš„ï¼›é™¡å³­çš„ï¼›ç»å¯¹çš„'},
        /* â€¦ æ­¤å¤„è¡¥å…¨æ‰€æœ‰ 39 æ¡ â€¦ */
        {word:'would they not',meaning:'ä»–ä»¬éš¾é“ä¸ä¼š...å—ï¼Ÿ'}
      ]
    };

    const KEY_DATA   = 'vocabData';
    const KEY_DICT   = 'dictRecords';
    const KEY_LISTEN = 'listenRecords';
    const KEY_REVIEW = 'reviewList';

    // ä» localStorage è½½å…¥å·²æœ‰ data
    function loadData(){
      const stored = JSON.parse(localStorage.getItem(KEY_DATA)||'{}');
      if(Object.keys(stored).length) data = stored;
    }
    function saveData(){
      localStorage.setItem(KEY_DATA, JSON.stringify(data));
    }
    // æ¸²æŸ“ç®¡ç†è¡¨æ ¼
    function renderWords(){
      const tbody = document.querySelector('#wordManageTable tbody');
      tbody.innerHTML = '';
      // é»˜è®¤å±•ç¤ºç¬¬ä¸€ä¸ªæ—¥æœŸ
      const list = data[Object.keys(data)[0]]||[];
      list.forEach(item=>{
        const tr = document.createElement('tr');
        const note = localStorage.getItem(`note_${item.word}`)||'';
        tr.innerHTML = `
          <td>${item.word}</td>
          <td>${item.meaning}</td>
          <td contenteditable 
              onblur="saveNote('${item.word}', this.innerText)">
            ${note}
          </td>`;
        tbody.appendChild(tr);
      });
    }
    function saveNote(word, txt){
      localStorage.setItem(`note_${word}`, txt);
    }

    // æ‰¹é‡æ·»åŠ ï¼šè‡ªåŠ¨æŠ“å–ä¸­æ–‡é‡Šä¹‰
    async function bulkAdd(){
      const words = document.getElementById('bulkInput')
                         .value.trim().split(/\s+/);
      const date = Object.keys(data)[0];
      data[date] = data[date]||[];
      for(const w of words){
        try {
          const res = await fetch(
            `https://api.dictionaryapi.dev/api/v2/entries/en/${w}`
          );
          const j = await res.json();
          const def = j[0]?.meanings[0]?.definitions[0]?.definition 
                      || 'æœªæ‰¾åˆ°é‡Šä¹‰';
          data[date].push({word:w,meaning:def});
        } catch {
          data[date].push({word:w,meaning:'æœªæ‰¾åˆ°é‡Šä¹‰'});
        }
      }
      saveData();
      renderWords();
      alert('æ·»åŠ å®Œæˆï¼š'+words.length+' ä¸ªå•è¯');
    }

    // åˆ‡æ¢æ¨¡å—
    function showSection(id){
      ['words','dictate','listen','review'].forEach(s=>{
        document.getElementById(s)
          .classList.toggle('hidden', s!==id);
      });
      if(id==='dictate') buildDictForm();
      if(id==='listen') buildListenForm();
      if(id==='review') loadReview();
    }

    // ----- é»˜å†™ -----
    function buildDictForm(){
      const sel = document.getElementById('dictDate');
      sel.innerHTML = '';
      Object.keys(data).forEach(d=>{
        sel.add(new Option(d,d));
      });
      const date = sel.value;
      const ctn = document.getElementById('dictForm');
      ctn.innerHTML = '';
      (data[date]||[]).forEach((it,i)=>{
        ctn.innerHTML += `
          <div>
            <label>${it.meaning}</label>
            <input id="d${i}" class="input-word">
          </div>`;
      });
    }
    function gradeDictation(){
      const d = document.getElementById('dictDate').value;
      const rec = JSON.parse(localStorage.getItem(KEY_DICT)||'[]');
      let ok=0, errs=[];
      data[d].forEach((it,i)=>{
        const ans = document.getElementById('d'+i).value.trim().toLowerCase();
        if(ans===it.word) ok++;
        else errs.push(it);
      });
      rec.push({date:d,total:data[d].length,correct:ok});
      localStorage.setItem(KEY_DICT, JSON.stringify(rec));
      addToReview(errs);
      document.getElementById('dictResult')
        .innerText = `${d}ï¼š${ok}/${data[d].length}`;
      loadDictStats();
    }
    function loadDictStats(){
      const rec = JSON.parse(localStorage.getItem(KEY_DICT)||'[]');
      const el = document.getElementById('dictStats');
      el.innerHTML = rec.map(r=>`<p>${r.date} ${r.correct}/${r.total}</p>`).join('');
    }

    // ----- å¬å†™ -----
    function buildListenForm(){
      const sel = document.getElementById('listenDate');
      sel.innerHTML = '';
      Object.keys(data).forEach(d=>{
        sel.add(new Option(d,d));
      });
      const date = sel.value;
      const ctn = document.getElementById('listenForm');
      ctn.innerHTML = '';
      (data[date]||[]).forEach((it,i)=>{
        ctn.innerHTML += `
          <div>
            <button class="play-btn" onclick="speak('${it.word}')">ğŸ”Š</button>
            <input id="l${i}" class="input-word" placeholder="å¬å†™è‹±æ–‡">
          </div>`;
      });
    }
    function gradeListening(){
      const d = document.getElementById('listenDate').value;
      const rec = JSON.parse(localStorage.getItem(KEY_LISTEN)||'[]');
      let ok=0, errs=[];
      data[d].forEach((it,i)=>{
        const ans = document.getElementById('l'+i).value.trim().toLowerCase();
        if(ans===it.word) ok++;
        else errs.push(it);
      });
      rec.push({date:d,total:data[d].length,correct:ok});
      localStorage.setItem(KEY_LISTEN, JSON.stringify(rec));
      addToReview(errs);
      document.getElementById('listenResult')
        .innerText = `${d}ï¼š${ok}/${data[d].length}`;
      loadListenStats();
    }
    function loadListenStats(){
      const rec = JSON.parse(localStorage.getItem(KEY_LISTEN)||'[]');
      const el = document.getElementById('listenStats');
      el.innerHTML = rec.map(r=>`<p>${r.date} ${r.correct}/${r.total}</p>`).join('');
    }

    // ----- å¤ä¹  -----
    function addToReview(arr){
      const list = JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');
      localStorage.setItem(KEY_REVIEW, JSON.stringify(list.concat(arr)));
    }
    function loadReview(){
      const list = JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');
      const form = document.getElementById('reviewForm');
      form.innerHTML = '';
      list.slice(0,20).forEach((it,i)=>{
        form.innerHTML += `
          <div>
            <button class="play-btn" onclick="speak('${it.word}')">ğŸ”Š</button>
            <label>${it.meaning}</label>
            <input id="r${i}" class="input-word">
          </div>`;
      });
    }
    function gradeReview(){
      let list = JSON.parse(localStorage.getItem(KEY_REVIEW)||'[]');
      const group = list.slice(0,20), remain = list.slice(20), errs=[];
      group.forEach((it,i)=>{
        const ans = document.getElementById('r'+i).value.trim().toLowerCase();
        if(ans!==it.word) errs.push(it);
      });
      localStorage.setItem(KEY_REVIEW, JSON.stringify(errs.concat(remain)));
      document.getElementById('reviewResult')
        .innerText = `å‰©ä½™${errs.concat(remain).length}è¯`;
    }

    // TTS æ’­è¯»
    function speak(text){
      const u = new SpeechSynthesisUtterance(text);
      u.lang = 'en-US';
      speechSynthesis.speak(u);
    }

    // åˆå§‹åŒ–
    window.onload = ()=>{
      loadData();
      renderWords();
      loadDictStats();
      loadListenStats();
    };
  </script>
</body>
</html>
