<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>每日单词 · 管理 / 默写 / 听写 / 复习</title>
<style>
  body{font-family:sans-serif;margin:0;background:#f9f9f9}
  header{background:#4CAF50;color:#fff;padding:12px;text-align:center}
  nav{display:flex;background:#333}
  nav button{flex:1;padding:10px;border:none;background:none;color:#fff;cursor:pointer}
  nav button:hover{background:#575757}
  .container{padding:20px}
  section{display:none}.active{display:block}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid #ccc;padding:8px;text-align:left}
  th{background:#f2f2f2}
  textarea{width:100%;height:60px;margin-top:10px}
  .input-word{width:70%;padding:4px;margin-top:4px}
  .btn{margin:10px 0;padding:6px 14px;cursor:pointer}
  .play{margin-right:6px;cursor:pointer}
  .del{color:red;cursor:pointer}
  ul{padding-left:20px;color:red}
</style>
</head>
<body>
<header><h1>每日单词 · 管理 / 默写 / 听写 / 复习</h1></header>

<nav>
  <button data-sec="manage">单词管理</button>
  <button data-sec="dict">默写练习</button>
  <button data-sec="listen">听写练习</button>
  <button data-sec="review">复习系统</button>
</nav>

<div class="container">
  <!-- 管理 -->
  <section id="manage" class="active">
    <h2>单词管理</h2>
    <label>日期: <input type="date" id="datePicker"></label>
    <textarea id="bulkInput" placeholder="将多个英文单词贴在这里，用空格分隔（普通空格或 键盘插入的中文空格都可）"></textarea>
    <button id="bulkBtn" class="btn">批量添加单词</button>
    <table>
      <thead><tr><th>单词</th><th>中文释义</th><th>备注</th><th>默写</th><th>听写</th><th>删除</th></tr></thead>
      <tbody id="manageBody"></tbody>
    </table>
  </section>

  <!-- 默写 -->
  <section id="dict">
    <h2>默写练习</h2>
    <label>选择日期: <input type="date" id="dictDate"></label>
    <button id="startDict" class="btn">开始默写</button>
    <div id="dictForm"></div>
    <button id="gradeDict" class="btn">批改默写</button>
    <div id="dictResult"></div>
  </section>

  <!-- 听写 -->
  <section id="listen">
    <h2>听写练习</h2>
    <label>选择日期: <input type="date" id="listenDate"></label>
    <button id="startListen" class="btn">开始听写</button>
    <div id="listenForm"></div>
    <button id="gradeListen" class="btn">批改听写</button>
    <div id="listenResult"></div>
  </section>

  <!-- 复习 -->
  <section id="review">
    <h2>复习系统</h2>
    <button id="loadReview" class="btn">加载错词</button>
    <div id="reviewForm"></div>
    <button id="gradeReview" class="btn">批改复习</button>
    <div id="reviewResult"></div>
  </section>
</div>

<script>
/* ============ 常量与持久化 ============ */
const KEY_DATA   = 'vocab_by_date';
const KEY_REVIEW = 'review_words';
let  data = JSON.parse(localStorage.getItem(KEY_DATA)||'{}');
function save(){ localStorage.setItem(KEY_DATA, JSON.stringify(data));}
function wordsOf(d){ return data[d] || []; }

/* ============ 工具函数 ============ */
const $ = id => document.getElementById(id);
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }}

/* Google Translate (中文释义) */
async function zh(word){
  try{
    const url=`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=zh-CN&dt=t&q=${encodeURIComponent(word)}`;
    const j=await (await fetch(url)).json();
    return j[0][0][0] || '';
  }catch{ return ''; }
}

/* iOS/桌面都可出的真人发音：优先 Youdao MP3，自动回退系统 voice */
function speak(w){
  const mp3=`https://dict.youdao.com/dictvoice?type=2&audio=${encodeURIComponent(w)}`;
  const audio=new Audio(mp3);
  audio.onerror=()=>{          // 若被墙或失败，退回 SpeechSynthesis
    let v=speechSynthesis.getVoices().find(v=>/^en/i.test(v.lang));
    const u=new SpeechSynthesisUtterance(w); u.voice=v||null; speechSynthesis.speak(u);
  };
  audio.play();
}

/* ============ 页面初始化 ============ */
const today=new Date().toISOString().slice(0,10);
['datePicker','dictDate','listenDate'].forEach(id=>$(id).value=today);
if(!data[today]) data[today]=[];
save();

/* 标签切换 */
document.querySelectorAll('nav button').forEach(btn=>btn.onclick=()=>{
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  $(btn.dataset.sec).classList.add('active');
});

/* 渲染管理表格 */
function renderMana
